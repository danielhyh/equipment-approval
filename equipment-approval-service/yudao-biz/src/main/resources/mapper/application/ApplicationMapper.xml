<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.iocoder.yudao.module.biz.dal.mysql.application.ApplicationMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
        文档可见：https://www.iocoder.cn/MyBatis/x-plugins/
     -->
    <select id="page" resultType="cn.iocoder.yudao.module.biz.controller.admin.application.vo.ApplicationPageRespVO">
        SELECT
        ba.id,
        bie.institution_name,
        ba.license_device_name,
        ba.ladder_config_model,
        ba.create_time,
        ba.app_status,
        ba.deadline,
        GREATEST(DATEDIFF(ba.deadline, NOW()), 0) AS remaining_days
        FROM
        biz_application ba
        JOIN
        biz_institution_ext bie ON ba.institution_id = bie.dept_id
        <where>
             and ba.deleted = 0
            <if test="reqVO.appType != null and reqVO.appType != ''">
                and app_type = #{reqVO.appType}
            </if>
            <if test="reqVO.licenseDeviceName != null and reqVO.licenseDeviceName != ''">
                and license_device_name = #{reqVO.licenseDeviceName}
            </if>
            <if test="reqVO.appStatus != null and reqVO.appStatus != ''">
                and app_status = #{reqVO.appStatus}
            </if>
            <if test="reqVO.deptOrDeviceName != null and reqVO.deptOrDeviceName != ''">
                and ( bie.institution_name like CONCAT('%', #{reqVO.deptOrDeviceName}, '%') OR
                ba.license_device_name like CONCAT('%', #{reqVO.deptOrDeviceName}, '%') )
            </if>
        </where>
        ORDER BY
        create_time DESC
    </select>
    
    <select id="selectBasicInfo" resultType="cn.iocoder.yudao.module.biz.controller.admin.application.vo.ApplicationBasicInformationVO">
        SELECT
            ba.id,
            app_no,
            institution_name,
            license_device_name,
            unified_social_credit_code,
            legal_person,
            contact_person,
            contact_phone,
            ownership_nature,
            ba.create_time,
            detailed_address,
            region
        FROM
            biz_application ba
                JOIN biz_institution_ext bie
        WHERE
            ba.id = #{id} and ba.deleted = 0
    </select>
    
    <select id="businessInfo" resultType="cn.iocoder.yudao.module.biz.controller.admin.application.vo.BusinessInfoVO">
        SELECT
            bce.license_device_name,
            ladder_config_model,
            equipment_config_address,
            production_enterprise,
            specific_model,
            serial_number,
            installation_date,
            purchase_price,
            special_description
        FROM
            biz_application ba
                JOIN biz_class_a_equipment bce ON ba.equipment_id = bce.id
        where ba.deleted = 0 and ba.id = #{id}
    </select>

    <select id="approvalDetails" resultType="cn.iocoder.yudao.module.biz.controller.admin.application.vo.ApprovalDetailsVO">
        SELECT
            initial_review_result,
            initial_review_opinion,
            expert_review_result,
            expert_review_opinion,
            expert_id,
            license_no,
            expert_attachments,
            license_generate_date

        FROM
            biz_application
        where id = #{id}
    </select>
</mapper>